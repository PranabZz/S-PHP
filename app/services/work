#!/usr/bin/env php
<?php

namespace App\Services;

require_once __DIR__ . '/JobQueue.php';
require_once __DIR__ . '/Job.php';

$jobQueue = new JobQueue();

echo "ðŸ“¢ Sending out resumes... Looking for work! ðŸ—ï¸\n";


declare(ticks=1);
pcntl_signal(SIGTERM, function () {
    echo "ðŸšª Received SIGTERM. Exiting job worker...\n";
    exit(0);
});
pcntl_signal(SIGINT, function () {
    echo "ðŸ‘‹ Received SIGINT (Ctrl+C). Bye for now!\n";
    exit(0);
});


$jobs = $jobQueue->getJobs();

if (empty($jobs)) {
    echo "ðŸ˜´ No jobs available... Waiting...\n";
    sleep(2);
    
}

echo "ðŸŽ‰ Got some work to do! Let's get started! ðŸš€\n";

$jobData = $jobs[0];

if (!isset($jobData['id'], $jobData['taskName'], $jobData['taskData'])) {
    echo "âš ï¸ Invalid job data found. Skipping... â­ï¸\n";
    file_put_contents('error.log', "âš ï¸ Invalid job data: " . print_r($jobData, true) . "\n", FILE_APPEND);
    $jobQueue->removeJobById($jobData['id'] ?? '');
    
}

$job = new Job($jobData['taskName'], $jobData['taskData']);
echo "ðŸ› ï¸ Processing job [{$jobData['id']}]: {$jobData['taskName']}...\n";

try {
    $job->execute();
    echo "âœ… Job [{$jobData['id']}] completed!\n";
} catch (\Exception $e) {
    echo "ðŸ’¥ Error executing job: {$e->getMessage()}\n";
    file_put_contents('error.log', "ðŸ’¥ Job failed: " . $e->getMessage() . "\n", FILE_APPEND);
}

$jobQueue->removeJobById($jobData['id']);
echo "ðŸ§¹ Job [{$jobData['id']}] removed from queue. ðŸŽ¯\n";



